function FileUploader(a){"use strict";var g,b=10,c={lang:{withFiles:"Прикрепить ещё файл",withoutFiles:"Прикрепить файл",hint:"до 10 файлов не более 4 Мб"},isMultiple:!0,maxFiles:b},d={},e=0,f=[];this.__construct=function(a){$.extend(c,a),g=this,d.container=$(c.selector),j(),k(),l(),m("undefined"!=typeof c.files&&c.files.length?c.lang.withFiles:c.lang.withoutFiles),this.__setEvents()};var h=function(){return c.hasOwnProperty("isMultiple")&&c.isMultiple===!1?1:0^c.maxFiles};this.__maxFileCount=h;var i=function(a){return isNaN(e)&&(e=0),"inc"==a?(e++,e>=h()&&d.fileAddButton.hide(),e):"dec"==a?(e--,e<h()&&d.fileAddButton.show(),e):e};this.__totalFiles=i;var j=function(){var a=$('<input type="file" class="file-uploader__file-input">');c.isMultiple&&a.prop("multiple",!0),d.fileInput=a;var b=$('<label class="file-uploader__add">');b.append(d.fileInput),b.append('<i class="icon ico-clip file-uploader__add-ico"></i>');var e=$('<span class="file-uploader__add-text"></span>');if(b.append(e),c.lang.hasOwnProperty("hint")){var f=$('<span class="file-uploader__add-hint">'+c.lang.hint+"</span>");b.append(f)}d.fileAddButton=b,d.fileAddButtonLabel=e,d.container.append(b)},k=function(){d.loadFileList=$('<div class="load-file__list">'),d.container.append(d.loadFileList)};this.__setEvents=function(){var a=this;d.fileInput.on("change",function(){m(c.lang.withFiles);for(var b=0;b<this.files.length&&!(i()>=h());b++)if(this.files[b]){var e=new FileUploaderItem(a,this.files[b],c.input,!0);d.loadFileList.append(e.get()),i("inc"),e.upload(),f.push(e)}return $(this).val(""),!1})};var l=function(){if("undefined"!=typeof c.files&&c.files.length)for(var a=0;a<c.files.length;a++){var b=c.files[a];if(b){var e=new FileUploaderItem(g,b,c.input);d.loadFileList.append(e.get()),i("inc")}}},m=function(a){d.fileAddButtonLabel.text(a)};return this.__construct(a),this.__canSave=function(){for(var a=0;a<f.length;a++){var b=f[a];if("load"==b.status())return!1}return!0},this.__clear=function(){for(var a=Object.keys(f),b=0;b<a.length;b++){var c=a[b];f[c].destroy(),delete f[c]}return f=[],!0},{totalFiles:i,canSave:this.__canSave,clear:this.__clear}}function FileUploaderItem(a,b,c,d){var j,k,e="/api?method=File.api_upload",f=4194304,g=b,h=c,i={},l=d===!0,m=function(){n()},n=function(){var b=$('<div class="file-item file-uploader__item">'),c=u(g.name);b.append('<i class="file-item__ext '+c+'">');var d=$('<span class="file-item__name">').text(g.name);b.append(d);var e=$('<a class="file-item__action">');e.append('<i class="file-item__action-ico">'),b.append(e);var f=$('<div class="file-item__loader" style="width: 0">');b.append(f);var k=$('<input type="hidden" name="'+h.name+'[delete][]">'),m=$('<input type="hidden" name="'+h.name+'[new][]">');i={$container:b,$name:d,$actionBtn:e,$deleteInput:k,$newInput:m,$loader:f},i.$actionBtn.on("click",function(){l?(a.__totalFiles("dec"),x(l),"undefined"!=typeof j&&0==j.status&&j.abort()):i.$container.data("onDelete")?a.__totalFiles()<a.__maxFileCount()&&(a.__totalFiles("inc"),B()):(a.__totalFiles("dec"),A())})},o=function(){if(!v())return y("error"),a.__totalFiles("dec"),!1;j=new XMLHttpRequest;var b=new FormData;b.append("upload_files",g),j.addEventListener("load",p),j.addEventListener("error",q),j.addEventListener("abort",s),j.upload.onprogress=r,j.open("POST",e,!0),C("load"),j.send(b)},p=function(){i.$loader.addClass("file-item__loader_success").animate({opacity:0}),i.$container.data("uploaded",!0);try{var b=JSON.parse(this.responseText)}catch(a){b={result:"error"}}"success"==b.result?t(b.file_id):(y("error"),a.__totalFiles("dec"),C("success"))},q=function(){y("error"),a.__totalFiles("dec")},r=function(a){var b=a.loaded/a.total*100^0;i.$loader.css("width",b+"%")},s=function(){C("abort")},t=function(a){a^=0,i.$newInput.val(a),i.$container.append(i.$newInput),C("success")},u=function(a){var b=a.length,c=a.substr(b-3,b).toLowerCase(),d=a.substr(b-4,b).toLowerCase(),e="";return e=$.inArray(c,["doc","xls","rtf","txt"])!=-1||$.inArray(d,["docx","xlsx"])!=-1?"ico-file-doc":$.inArray(c,["zip","rar"])!=-1?"ico-file-zip":$.inArray(c,["png","jpg","gif","psd"])!=-1||$.inArray(d,["jpeg"])!=-1?"ico-file-image":$.inArray(c,["mp3","wav","avi"])!=-1?"ico-file-audio":"ico-file-zip"},v=function(){return g.size<=f},w=function(){return i.$container},x=function(a){i.$container.animate({opacity:0,height:0,margin:0},200,function(){a&&(i.$container.remove(),i=null)})},y=function(a){switch(a){case"deleted":i.$container.addClass("file-item_type_deleted");break;case"error":i.$container.addClass("file-item_type_error")}},z=function(a){switch(a){case"deleted":i.$container.removeClass("file-item_type_deleted");break;case"error":i.$container.removeClass("file-item_type_error")}},A=function(){g.id&&(y("deleted"),i.$container.append(i.$deleteInput),i.$deleteInput.val(g.id),i.$container.data("onDelete",!0))},B=function(){z("deleted"),i.$deleteInput.detach(),i.$container.data("onDelete",!1)},C=function(a){k=a},D=function(){return k},E=function(){null!==i&&(i.$container.remove(),a.__totalFiles("dec"))};return m(),{upload:o,get:w,status:D,destroy:E}}